digraph sns_pipeline {
// overall graph label
label="NGS580 Data Analysis Pipeline\n\n"
labelloc="t";

graph [fontname = "helvetica"];
node [fontname = "helvetica"];
edge [fontname = "helvetica"];

// define all the nodes in the order of appearance
Trimmomatic
BWA_MEM
Sambamba
Rsamtools
GATK_DepthOfCoverage
GATK_Realign
GATK_Recalibrate
LoFreq
GATK_HaplotypeCaller
GATK_MuTect2
ANNOVAR
Reporting
QC
Review

// add styles and labels to the pipeline steps
// pre-processing pipeline steps
Trimmomatic [
    label=<<FONT POINT-SIZE="18">Trimmomatic</FONT><BR />
    <FONT POINT-SIZE="12">
    trim low quality reads<BR />
    &#8226; input: .fastq<BR />
    &#8226; output: .fastq
    </FONT>>,
    style=rounded, shape=box, color=Blue
    ]

BWA_MEM [
    label=<<FONT POINT-SIZE="18">BWA MEM</FONT><BR />
    <FONT POINT-SIZE="12">
    align reads<BR />
    &#8226; input: .fastq<BR />
    &#8226; output: .bam
    </FONT>>,
    style=rounded, shape=box, color=Blue
    ]

Sambamba [
    label=<<FONT POINT-SIZE="18">Sambamba</FONT><BR />
    <FONT POINT-SIZE="12">
    filter poorly mapped reads<BR />
    &#8226; input: .bam<BR />
    &#8226; output: .bam
    </FONT>>,
    style=rounded, shape=box, color=Blue
    ]

GATK_Realign [
    label=<<FONT POINT-SIZE="18">GATK</FONT><BR />
    <FONT POINT-SIZE="16">
    RealignerTargetCreator<BR />
    IndelRealigner<BR />
    BaseRecalibrator<BR />
    </FONT>
    <FONT POINT-SIZE="12">
    recalibrate and realign reads<BR />
    &#8226; input: .bam<BR />
    &#8226; output: .bam
    </FONT>>,
    style=rounded, shape=box, color=Blue
    ]

GATK_Recalibrate [
    label=<<FONT POINT-SIZE="18">GATK</FONT><BR />
    <FONT POINT-SIZE="16">
    AnalyzeCovariates<BR />
    PrintReads<BR />
    BaseRecalibrator<BR />
    </FONT>
    <FONT POINT-SIZE="12">
    visualize and save recalibration results<BR />
    &#8226; input: .bam<BR />
    &#8226; output: .bam, .txt, .pdf
    </FONT>>,
    style=rounded, shape=box, color=Blue
    ]

// quality control pipeline steps -
Rsamtools [
    label=<<FONT POINT-SIZE="18">Rsamtools</FONT><BR />
    <FONT POINT-SIZE="12">
    calculate and visualize fragment sizes<BR />
    &#8226; input: .bam<BR />
    &#8226; output: .pdf
    </FONT>>,
    style=rounded, shape=box, color=Orange
    ]

GATK_DepthOfCoverage [
    label=<<FONT POINT-SIZE="18">GATK<BR />DepthOfCoverage</FONT><BR />
    <FONT POINT-SIZE="12">
    evaluate coverage at target regions<BR />
    &#8226; input: .bam<BR />
    &#8226; output: .txt
    </FONT>>,
    style=rounded, shape=box, color=Orange
    ]


// Variant Calling pipeline steps
LoFreq [
    label=<<FONT POINT-SIZE="18">LoFreq</FONT><BR />
    <FONT POINT-SIZE="12">
    high sensitivity variant calling<BR />
    &#8226; input: .bam, .bed<BR />
    &#8226; output: .vcf
    </FONT>>,
    style=rounded, shape=box, color=Green
    ]

GATK_HaplotypeCaller [
    label=<<FONT POINT-SIZE="18">GATK<BR />HaplotypeCaller</FONT><BR />
    <FONT POINT-SIZE="12">
    variant calling<BR />
    &#8226; input: .bam, .bed<BR />
    &#8226; output: .vcf
    </FONT>>,
    style=rounded, shape=box, color=Green
    ]

GATK_MuTect2 [
    label=<<FONT POINT-SIZE="18">GATK<BR />MuTect2</FONT><BR />
    <FONT POINT-SIZE="12">
    tumor-normal variant calling<BR />
    &#8226; input: .bam, .bed<BR />
    &#8226; output: .vcf
    </FONT>>,
    style=rounded, shape=box, color=Green]

ANNOVAR [
    label=<<FONT POINT-SIZE="18">ANNOVAR</FONT><BR />
    <FONT POINT-SIZE="12">
    Variant annotation<BR />
    &#8226; input: .vcf<BR />
    &#8226; output: .txt
    </FONT>>,
    style=rounded, shape=box, color=Green
    ]

// custom downstream steps
Reporting [
    label=<<FONT POINT-SIZE="14">Custom Report Generation</FONT>>,
    style=rounded, shape=box, color=Black
    ]

QC [
    label=<<FONT POINT-SIZE="14">QC Check and email output</FONT>>,
    style=rounded, shape=box, color=Black
    ]

Review [
    label=<<FONT POINT-SIZE="14">Clinical Review</FONT>>,
    style=rounded, shape=box, color=Black
    ]

// layout
    subgraph cluster1 {
        style="invis"
        Trimmomatic -> BWA_MEM -> Sambamba -> Rsamtools -> GATK_DepthOfCoverage
    }

    subgraph cluster2 {
        style="invis"
         GATK_Realign -> GATK_Recalibrate
         GATK_Recalibrate -> LoFreq -> ANNOVAR
         GATK_Recalibrate -> GATK_HaplotypeCaller -> ANNOVAR
         GATK_Recalibrate -> GATK_MuTect2 -> ANNOVAR
    }

    splines="ortho"
    {rank=same Trimmomatic GATK_Realign}
    GATK_DepthOfCoverage -> GATK_Realign [constraint=false]
    ANNOVAR -> Reporting

    Reporting -> QC
    Reporting -> Review
}
